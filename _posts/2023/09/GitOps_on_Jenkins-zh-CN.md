---
title: Jenkins 管道上的 GitOps
date: 2023-09-25
tags:
  - GitOps
  - Jenkins
  - Groovy
categories:
  - Development
lang: zh-CN
excerpt: 凌晨3点部署出错？只需 git revert 即可回滚！学习如何用种子脚本实现 Jenkins 管道的 GitOps。
thumbnail: /assets/jenkins/thumbnail.png
---

## 什么是 GitOps？

想象一下：凌晨 3 点，部署出错了。你不必疯狂地点击 Jenkins UI 试图记住你改变了什么，而是简单地运行 `git revert` 并重新部署。这就是 GitOps 的力量。

GitOps 意味着像管理 Git 中的代码一样管理你的整个基础设施——每个更改都被跟踪，每个部署都可重现，每个回滚只需一次提交。

GitOps 是一种使用 Git 作为单一事实来源来管理基础设施和应用程序的方法。它让你在代码中定义所需状态，然后使用工具将该状态应用到你的环境中。GitOps 实现持续交付，因为 Git 仓库中的任何更改都会触发部署新版本代码的管道。

{% mermaid %}
graph LR
    A([开发者]) -->|提交| B[(Git 仓库)]
    B -->|触发| C[CI/CD 管道]
    E[(对象存储)] -->|读取状态| C
    C -->|部署| D[基础设施]
    D -->|写入状态| E
    
    style B fill:#87CEEB
    style C fill:#90EE90
    style D fill:#FFD700
    style E fill:#FFA07A
{% endmermaid %}

## Jenkins 管道的 GitOps

在 Jenkins 管道的上下文中，GitOps 可用于通过将管道配置视为代码并使用 Git 管理对该代码的更改来管理管道。这允许开发者对其管道配置进行版本控制，与其他团队成员协作更改，并在必要时轻松回滚更改。

换句话说：不是手动点击 Jenkins UI 来创建和配置管道，而是编写描述你想要的管道的代码，将其提交到 Git，并让自动化为你创建它们。

### 使用种子脚本管理 Jenkins 管道

种子脚本是用于在 Jenkins 上创建和维护管道的脚本。它通常用 Groovy 脚本编写。

以下是在 Jenkins 中创建管道的种子脚本示例。该脚本使用 Job DSL 插件以声明方式定义管道作业。脚本循环遍历仓库列表并为每个仓库创建管道作业。每个管道的步骤详细信息从其自己仓库中的 Jenkinsfile 引用。

三个管道可能看起来不太令人印象深刻。但考虑为多个环境创建管道——这就是种子脚本真正发挥作用的地方。

虽然种子脚本可用于定义管道中的详细步骤，但重要的是保持这些脚本简单并专注于管理管道。保持种子脚本简单使其更容易维护并与其他团队成员协作。

!!!tip "💡 最佳实践"
    保持你的种子脚本专注于管道结构和配置。将实际的管道逻辑存储在每个仓库内的 Jenkinsfile 中。这种关注点分离使两者都更容易维护。

### 使用种子脚本的好处

使用种子脚本可以带来几个好处，包括：

- **自动化**：你可以根据 Git 仓库中的更改自动创建和更新 Jenkins 管道。这减少了手动错误并节省了时间和精力。
- **不可变性**：你可以保持 Jenkins 管道不可变，这意味着它们在创建后不会手动修改。这确保了不同环境和阶段之间的一致性和可靠性。
- **版本控制**：你可以使用 Git 提交和分支跟踪 Jenkins 管道的历史和更改。这使你能够回滚到以前的版本、比较不同版本并审计更改。
- **协作**：你可以使用 Git 功能（如拉取请求、代码审查和合并冲突）与其他开发者和团队协作处理 Jenkins 管道。这提高了管道的质量和安全性。
- **恢复**：如果 Jenkins 意外损坏或删除，你可以使用种子作业从 Git 仓库重新部署管道。
- **可移植性**：你可以使用 GitOps 在另一个 Jenkins 服务器上创建相同的管道集。这在你想使用 Jenkins/插件升级测试管道时特别有用。

### 挑战和解决方案

然而，当使用 GitOps 生成 Jenkins 管道时，你需要注意一些挑战。

!!!warning "⚠️ 管道删除和审计日志"
    当你使用 GitOps 生成 Jenkins 管道时，你也可以使用 GitOps 在不再需要时销毁它们。然而，如果你需要保留管道执行的输出（控制台日志）以进行审计或故障排除，这可能会导致问题。

**要考虑的解决方案：**

1. **外部日志存储**：在删除管道之前，使用单独的存储系统（如 Elasticsearch、CloudWatch 或 S3）归档日志
2. **软删除**：将管道标记为已弃用，而不是立即删除它们
3. **保留策略**：实施具有可配置保留期的自动归档

### 安全考虑

!!!danger "🔒 安全最佳实践"
    GitOps 引入了新的安全考虑，因为你的管道配置存储在 Git 中。

**关键安全实践：**

- **凭证管理**：永远不要在种子脚本中存储凭证。使用 Jenkins 凭证插件并通过 ID 引用它们
- **访问控制**：实施分支保护并要求对种子脚本更改进行代码审查
- **审计追踪**：启用 Git 提交签名以验证更改的真实性
- **最小权限**：仅授予种子作业创建/更新管道所需的权限

### 状态管理模式

随着你的 GitOps 实施成熟，你需要决定如何处理状态——实际部署的内容与 Git 中定义的内容的记录。

!!!anote "📦 状态同步：对象存储 vs Git 版本控制"
    虽然 GitOps 传统上使用 Git 进行状态管理，但一些团队将状态存储在对象存储（S3、Azure Blob）中，而不是在 Git 中进行版本控制。
    
    **为什么使用对象存储来存储状态？**
    
    - **大小限制**：Terraform 状态文件或大型配置输出可能会使 Git 仓库膨胀，使克隆变慢且历史记录笨重
    - **二进制数据**：状态文件通常包含二进制或频繁更改的数据，这些数据不会从 Git 的差异功能中受益
    - **并发性**：具有锁定机制的对象存储（如 S3 + DynamoDB）比 Git 合并冲突更好地防止并发修改
    - **性能**：使用对象存储读取/写入大型状态文件比 Git 操作更快
    - **关注点分离**：配置（Git）与运行时状态（对象存储）本质上是不同的——一个是意图，另一个是现实
    
    把它想象成建筑计划与检查报告：你对蓝图进行版本控制（Git），但将检查结果存储在文件柜中（对象存储）。

## 超越 Jenkins：无处不在的 GitOps

GitOps 是一个概念，你可以通过使用 Git 作为单一事实来源来应用于自动化一切运维。Jenkins 只是其中一个应用程序。相同的原则适用于：

- **基础设施即代码**：Terraform、CloudFormation、Pulumi
- **Kubernetes**：ArgoCD、Flux 用于集群管理
- **配置管理**：Ansible、Chef、Puppet
- **监控**：Grafana 仪表板、Prometheus 规则

!!!success "✨ 关键要点"
    GitOps 将运维从手动、容易出错的流程转变为自动化、可审计和可重现的工作流程。通过将一切视为代码并使用 Git 作为事实来源，你可以获得整个基础设施的版本控制、协作和可靠性。

!!!tip "🚀 入门"
    准备为你的 Jenkins 管道实施 GitOps？
    
    1. **从小处开始**：将一个手动管道转换为种子脚本
    2. **在沙盒中测试**：首先使用非生产 Jenkins 实例
    3. **逐步扩展**：一旦你感到舒适，添加更多管道
    4. **添加可观察性**：一旦稳定，实施监控和警报
    5. **记录模式**：为你的团队创建模板以遵循
