---
title: 監視のベストプラクティス - 可観測性が推測に勝る理由
date: 2020-10-01
categories:
  - Development
tags:
  - Monitoring
  - DevOps
  - Best Practices
lang: ja
excerpt: "見えないものは修正できません。適切な監視が反応的な消火活動をどのように積極的な問題解決に変えるか、そしてなぜ可観測性がシステムの健康保険であるかを発見してください。"
thumbnail: /assets/monitoring/thumbnail.png
---

ソフトウェア運用の世界には、危険な仮定があります：ユーザーが文句を言っていなければ、すべてが順調に違いない。何年もの間、チームは暗闇の中で運用し、顧客が報告したときにのみ問題を発見してきました - あるいはさらに悪いことに、収益が落ちたときに。しかし、問題が災害になる前に見ることができたらどうでしょうか？

監視は、システムが健康であることを知ることと、そうであることを期待することの違いです。それは、問題を数時間ではなく数分で修正することの違いです。それは、積極的なエンジニアリングと反応的な消火活動の違いです。しかし、多くのチームは監視を後付けとして扱い、「時間があるときに」追加するものとしています。

これは単にメトリクスを収集することではありません - 初日からシステムに可観測性を組み込むことです。データを洞察に、洞察を行動に変換することです。

## 盲目で飛行するコスト

適切な監視なしで運用することは、目を閉じて運転するようなものです。しばらくは幸運かもしれませんが、最終的にはクラッシュします。結果は現実的です：

**遅延したインシデント検出**：誰かが気づく前に問題が何時間も悪化します。メモリリークがゆっくりとパフォーマンスを低下させます。故障したディスクが気づかれずにいっぱいになります。ユーザーが苦情を言う頃には、損害は完了しています。

**延長されたダウンタイム**：監視がなければ、何が壊れているかわかりません。データベースですか？アプリケーションサーバーですか？ネットワークですか？修正する代わりに調査に貴重な時間を無駄にします。

**収益損失**：ダウンタイムの1分ごとにお金がかかります。Eコマースサイトの場合、短い停止でさえ直接売上損失につながります。SaaSプラットフォームの場合、顧客の信頼を損ないます。

**劣化したユーザーエクスペリエンス**：遅い応答時間はユーザーを遠ざけます。しかし、監視がなければ、どのページが遅いか、どのAPIがタイムアウトしているか、どのユーザーが影響を受けているかわかりません。

**反応的な文化**：チームは構築する代わりに消火に時間を費やします。毎日新しい驚きがもたらされます。燃え尽き症候群は必然的に続きます。

**逃した最適化の機会**：測定しないものは改善できません。データがなければ、どの最適化が役立つかを推測しています。

!!!warning "⚠️ 隠れたコスト"
    中規模のEコマースサイトの1時間のダウンタイムは、$100,000以上のコストがかかる可能性があります。数時間ではなく数秒で問題を検出する適切な監視は、費用ではありません - 保険です。

## 監視が実際に意味すること

監視は単にデータを収集することではありません - システムの健康状態の包括的な理解を構築することです。最新の監視にはいくつかのレイヤーが含まれます：

**インフラストラクチャ監視**：CPU使用率、メモリ消費、ディスクI/O、ネットワークスループット。システムヘルスの基盤。

**アプリケーション監視**：リクエスト率、応答時間、エラー率、スループット。コードが本番環境で実際にどのように実行されるか。

**ログ集約**：すべてのサービスを検索できる集中ログ。何かが壊れたとき、ログは理由を教えてくれます。

**分散トレーシング**：マイクロサービス全体でリクエストを追跡。複雑なアーキテクチャで時間がどこに費やされているかを理解。

**合成監視**：重要なユーザージャーニーを積極的にテスト。実際のユーザーが遭遇する前に問題をキャッチ。

**ビジネスメトリクス**：コンバージョン率、トランザクション量、ユーザーサインアップ。技術的健康をビジネス成果に接続。

目標はすべての可能なメトリクスを収集することではありません - 何かが間違っているときに教えてくれ、なぜかを診断するのに役立つ適切なメトリクスを収集することです。

## 4つのゴールデンシグナル

GoogleのSite Reliability Engineeringチームは、ユーザー向けシステムの監視に最も重要な4つのメトリクスを特定しました：

**レイテンシ**：リクエストを処理するのにどれくらい時間がかかりますか？成功したリクエストと失敗したリクエストを別々に追跡 - 高速な失敗も失敗です。

**トラフィック**：システムはどれだけの需要を処理していますか？毎秒のリクエスト、毎分のトランザクション、同時ユーザー。

**エラー**：エラー率は何ですか？明示的な失敗（500エラー）と暗黙的な失敗（間違ったコンテンツ、遅い応答）の両方を追跡。

**飽和**：システムはどれだけいっぱいですか？CPUが90％、メモリが95％、ディスクが80％ - これらは差し迫った失敗の警告サインです。

{% echarts %}
{
  "title": {
    "text": "ゴールデンシグナル：システムヘルス概要",
    "left": "center"
  },
  "tooltip": {
    "trigger": "axis",
    "axisPointer": {
      "type": "shadow"
    }
  },
  "legend": {
    "data": ["健康", "警告", "クリティカル"],
    "top": "10%"
  },
  "grid": {
    "left": "3%",
    "right": "4%",
    "bottom": "3%",
    "containLabel": true
  },
  "xAxis": {
    "type": "category",
    "data": ["レイテンシ\\n(ms)", "トラフィック\\n(req/s)", "エラー\\n(%)", "飽和\\n(%)"]
  },
  "yAxis": {
    "type": "value",
    "name": "しきい値レベル"
  },
  "series": [
    {
      "name": "健康",
      "type": "bar",
      "stack": "total",
      "data": [200, 1000, 0.1, 60],
      "itemStyle": {
        "color": "#51cf66"
      }
    },
    {
      "name": "警告",
      "type": "bar",
      "stack": "total",
      "data": [300, 500, 0.9, 20],
      "itemStyle": {
        "color": "#ffd43b"
      }
    },
    {
      "name": "クリティカル",
      "type": "bar",
      "stack": "total",
      "data": [500, 200, 4, 20],
      "itemStyle": {
        "color": "#ff6b6b"
      }
    }
  ]
}
{% endecharts %}

!!!tip "💡 ゴールデンシグナルから始める"
    ゼロから監視を構築している場合は、ここから始めてください。これらの4つのメトリクスは、20％の労力で80％の価値を提供します。ニーズが現れるにつれて、より洗練された監視を追加します。

これらのシグナルは、ユーザー中心であるため機能します。「私のサービスは今ユーザーにとってうまく機能していますか？」という質問に答えます。

## メトリクス vs ログ vs トレース

可観測性の3つの柱の違いを理解することは重要です：

**メトリクス**は時間経過に伴う数値測定です。収集と保存が安価で、ダッシュボードとアラートに最適です。「CPU使用率は85％」または「応答時間は250ms」。

**ログ**はコンテキストを持つ離散イベントです。保存にコストがかかりますが、デバッグには非常に貴重です。「ユーザー12345はパスワードが正しくなかったため認証に失敗しました。」

**トレース**はシステムを通るリクエストのパスを示します。分散システムを理解するために不可欠です。「このチェックアウトリクエストは支払いサービスで2秒を費やしました。」

それぞれ異なる目的を果たします：
- メトリクスは何かが間違っていることを教えてくれます
- ログはなぜ間違っているかを教えてくれます
- トレースはどこが間違っているかを教えてくれます

{% mermaid %}graph TD
    A["🔔 アラートトリガー"] --> B["📊 メトリクス"]
    B --> C{"何が間違っている?"}
    C --> D["📝 ログ"]
    D --> E{"なぜ失敗した?"}
    E --> F["🔍 トレース"]
    F --> G["✅ 根本原因発見"]
    
    style A fill:#ff6b6b,stroke:#c92a2a,color:#fff
    style B fill:#4dabf7,stroke:#1971c2,color:#fff
    style D fill:#51cf66,stroke:#2f9e44,color:#fff
    style F fill:#ffd43b,stroke:#f59f00,color:#000
    style G fill:#69db7c,stroke:#2f9e44,color:#fff
{% endmermaid %}

!!!info "ℹ️ 可観測性の三角形"
    メトリクス、ログ、トレースは連携して機能します。メトリクスは問題を警告し、ログは根本原因の診断を助け、トレースはリクエストフローを示します。完全な可観測性には3つすべてが必要です。

## 監視におけるログ

ログは、何かが間違ったときに詳細なコンテキストを提供することでメトリクスを補完します。メトリクスが問題があることを教えてくれる一方で、ログはなぜかを教えてくれます。

**ログが監視に重要な場合**：

**デバッグコンテキスト**：メトリクスはエラー率が急上昇したことを示します。ログは「データベース接続プールが枯渇」または「支払いゲートウェイタイムアウト」 - 特定の失敗を示します。

**セキュリティイベント**：ログイン試行の失敗、不正アクセス試行、SQLインジェクション検出 - 即座のアラートが必要な重要なイベント。

**ビジネス異常**：高額トランザクションの失敗、在庫の不一致、異常な返金パターン - 収益に影響を与えるイベント。

!!!info "📝 詳細：アプリケーションログ"
    アプリケーションログ戦略、構造化ログ、ログ保持、ログ監視パターンは独自の議論に値します。ログ標準、設計時戦略、ログ管理の包括的なカバレッジについては、[アプリケーションログのベストプラクティス](/ja/2020/11/Application-Logging-Best-Practices-From-Design-to-Production/)を参照してください。

**ログ集約ツール**：CloudWatch Logs、ELK Stack、Splunk、Loki + Grafanaは、すべてのサービスにわたる集中ログ収集と検索を提供します。

**ログパターンでアラート**：特定のエラーメッセージ、セキュリティイベント、またはビジネス異常を監視します。包括的なカバレッジのためにログベースのアラートとメトリクスベースのアラートを組み合わせます。

