---
title: "Claim-Check æ¨¡å¼ï¼šåœ¨åˆ†æ•£å¼ç³»çµ±ä¸­è™•ç†å¤§å‹è¨Šæ¯"
date: 2019-04-10
lang: zh-TW
categories: Architecture
tags:
  - Architecture
series: architecture_pattern
  - Design Patterns
  - Messaging
excerpt: "äº†è§£ Claim-Check æ¨¡å¼å¦‚ä½•é€éå°‡è³‡æ–™å„²å­˜åœ¨å¤–éƒ¨ä¸¦å‚³éè¼•é‡ç´šæ¬Šæ–ï¼Œè§£æ±ºè¨Šæ¯ç³»çµ±ä¸­å‚³è¼¸å¤§å‹è² è¼‰çš„æŒ‘æˆ°ã€‚"
thumbnail: /assets/architecture/thumbnail.png
thumbnail_80: /assets/architecture/thumbnail_80.png
comments: true
---

æƒ³åƒä¸€ä¸‹åœ¨æ©Ÿå ´è¨—é‹è¡Œæçš„æƒ…æ™¯ã€‚ä½ ä¸éœ€è¦å¸¶è‘—æ²‰é‡çš„è¡Œæé€šéå®‰æª¢å’Œç™»æ©Ÿï¼Œè€Œæ˜¯åœ¨å ±åˆ°æ«ƒæª¯äº¤å‡ºè¡Œæï¼Œä¸¦æ”¶åˆ°ä¸€å¼µå°å°çš„æé ˜å–®ã€‚åˆ°é”ç›®çš„åœ°å¾Œï¼Œä½ å‡ºç¤ºæé ˜å–®å°±èƒ½å–å›è¡Œæã€‚é€™å€‹çœŸå¯¦ä¸–ç•Œçš„æµç¨‹å•Ÿç™¼äº†åˆ†æ•£å¼ç³»çµ±ä¸­ä¸€å€‹æœ€å„ªé›…çš„è§£æ±ºæ–¹æ¡ˆï¼šClaim-Check æ¨¡å¼ã€‚

## å•é¡Œï¼šç•¶è¨Šæ¯è®Šå¾—å¤ªé‡

å‚³çµ±è¨Šæ¯ç³»çµ±æ“…é•·è™•ç†å¤§é‡çš„å°å‹è¨Šæ¯ã€‚å®ƒå€‘é‡å°é€Ÿåº¦ã€ååé‡å’Œå¯é æ€§é€²è¡Œäº†å„ªåŒ–ï¼Œç‰¹åˆ¥æ˜¯åœ¨è™•ç†è¼•é‡ç´šè³‡æ–™æ™‚ã€‚ç„¶è€Œï¼Œå®ƒå€‘åœ¨è™•ç†å¤§å‹è² è¼‰æ™‚å¸¸å¸¸é‡åˆ°å›°é›£ï¼ŒåŸå› å¦‚ä¸‹ï¼š

- **å¤§å°é™åˆ¶**ï¼šå¤§å¤šæ•¸è¨Šæ¯ç³»çµ±å°è¨Šæ¯å¤§å°æœ‰åš´æ ¼é™åˆ¶ï¼ˆé€šå¸¸ç‚º 256KB åˆ° 1MBï¼‰
- **æ•ˆèƒ½ä¸‹é™**ï¼šå¤§å‹è¨Šæ¯æ¶ˆè€—æ›´å¤šè¨˜æ†¶é«”å’Œé »å¯¬ï¼Œæ‹–æ…¢æ•´å€‹ç³»çµ±
- **é€¾æ™‚å•é¡Œ**ï¼šè™•ç†å¤§å‹è¨Šæ¯å¯èƒ½è¶…éé€¾æ™‚é–¾å€¼
- **è³‡æºè€—ç›¡**ï¼šå¤šå€‹å¤§å‹è¨Šæ¯å¯èƒ½å£“å®è¨Šæ¯åŸºç¤è¨­æ–½

!!!warning "âš ï¸ å¯¦éš›å½±éŸ¿"
    åœ¨è¨­è¨ˆç”¨æ–¼è™•ç† 64KB è¨Šæ¯çš„ä½‡åˆ—ä¸­ï¼Œå–®ä¸€ 10MB è¨Šæ¯å¯èƒ½å°è‡´é€£é–æ•…éšœï¼Œå½±éŸ¿æ‰€æœ‰æ¶ˆè²»è€…ï¼Œç”šè‡³å¯èƒ½å°è‡´æ•´å€‹è¨Šæ¯ç³»çµ±å´©æ½°ã€‚

## è§£æ±ºæ–¹æ¡ˆï¼šå°‡å„²å­˜èˆ‡è¨Šæ¯å‚³éåˆ†é›¢

Claim-Check æ¨¡å¼é€éåˆ†é›¢è³‡æ–™å„²å­˜å’Œè¨Šæ¯å‚³éçš„é—œæ³¨é»ï¼Œå„ªé›…åœ°è§£æ±ºäº†é€™å€‹å•é¡Œï¼š

1. **å„²å­˜è² è¼‰**åˆ°é‡å°å¤§å‹ç‰©ä»¶å„ªåŒ–çš„å¤–éƒ¨è³‡æ–™å„²å­˜
2. **ç”¢ç”Ÿ claim-check æ¬Šæ–**ï¼ˆå”¯ä¸€è­˜åˆ¥ç¢¼æˆ–é‡‘é‘°ï¼‰
3. **åƒ…é€éè¨Šæ¯ç³»çµ±å‚³é€æ¬Šæ–**
4. **åœ¨éœ€è¦æ™‚ä½¿ç”¨æ¬Šæ–å–å›è² è¼‰**

```mermaid
sequenceDiagram
    participant Sender as å‚³é€è€…
    participant DataStore as å¤–éƒ¨è³‡æ–™å„²å­˜
    participant MsgSystem as è¨Šæ¯ç³»çµ±
    participant Receiver as æ¥æ”¶è€…
    
    Sender->>DataStore: 1. å„²å­˜å¤§å‹è² è¼‰
    DataStore-->>Sender: 2. å›å‚³ claim-check æ¬Šæ–
    Sender->>MsgSystem: 3. å‚³é€å¸¶æœ‰æ¬Šæ–çš„è¨Šæ¯
    MsgSystem->>Receiver: 4. å‚³éå¸¶æœ‰æ¬Šæ–çš„è¨Šæ¯
    Receiver->>DataStore: 5. ä½¿ç”¨æ¬Šæ–å–å›è² è¼‰
    DataStore-->>Receiver: 6. å›å‚³è² è¼‰
    Receiver->>Receiver: 7. è™•ç†è² è¼‰
```

## é‹ä½œæ–¹å¼ï¼šæ¨¡å¼å¯¦ä½œ

è®“æˆ‘å€‘é€éä¸€å€‹è™•ç†å¸¶æœ‰å¤§å‹é™„ä»¶çš„å®¢æˆ¶è¨‚å–®çš„å…·é«”ç¯„ä¾‹ä¾†èªªæ˜ï¼š

### æ­¥é©Ÿ 1ï¼šå„²å­˜è² è¼‰

ç•¶å‚³é€è€…éœ€è¦å‚³è¼¸å¤§å‹è² è¼‰ï¼ˆä¾‹å¦‚é«˜è§£æåº¦åœ–ç‰‡ã€å½±ç‰‡æª”æ¡ˆæˆ–å¤§å‹æ–‡ä»¶ï¼‰æ™‚ï¼š

```javascript
// å‚³é€è€…æ‡‰ç”¨ç¨‹å¼
async function sendLargeMessage(payload) {
  // å°‡è² è¼‰å„²å­˜åœ¨å¤–éƒ¨è³‡æ–™å„²å­˜
  const claimCheckToken = await dataStore.save({
    data: payload,
    expiresAt: Date.now() + (24 * 60 * 60 * 1000) // 24 å°æ™‚
  });
  
  return claimCheckToken;
}
```

### æ­¥é©Ÿ 2ï¼šå‚³é€æ¬Šæ–

è¨Šæ¯ç³»çµ±åªè™•ç†è¼•é‡ç´šæ¬Šæ–ï¼š

```javascript
// å‚³é€å¸¶æœ‰ claim-check æ¬Šæ–çš„è¨Šæ¯
await messagingSystem.send({
  orderId: "ORD-12345",
  claimCheck: claimCheckToken,
  metadata: {
    size: payload.length,
    contentType: "application/pdf"
  }
});
```

### æ­¥é©Ÿ 3ï¼šå–å›ä¸¦è™•ç†

æ¥æ”¶è€…ä½¿ç”¨æ¬Šæ–å–å¾—å¯¦éš›è² è¼‰ï¼š

```javascript
// æ¥æ”¶è€…æ‡‰ç”¨ç¨‹å¼
async function processMessage(message) {
  // ä½¿ç”¨ claim-check æ¬Šæ–å–å›è² è¼‰
  const payload = await dataStore.retrieve(message.claimCheck);
  
  // è™•ç†è² è¼‰
  await processOrder(message.orderId, payload);
  
  // æ¸…ç†
  await dataStore.delete(message.claimCheck);
}
```

## å¯¦ä½œè€ƒé‡

å¯¦ä½œ Claim-Check æ¨¡å¼æ™‚ï¼Œè«‹è€ƒæ…®ä»¥ä¸‹é‡è¦é¢å‘ï¼š

### 1. è² è¼‰ç”Ÿå‘½é€±æœŸç®¡ç†

!!!tip "ğŸ—‘ï¸ æ¸…ç†ç­–ç•¥"
    **åŒæ­¥åˆªé™¤**ï¼šæ¶ˆè²»æ‡‰ç”¨ç¨‹å¼åœ¨è™•ç†å¾Œç«‹å³åˆªé™¤è² è¼‰ã€‚é€™å°‡åˆªé™¤èˆ‡è¨Šæ¯å·¥ä½œæµç¨‹ç¶å®šï¼Œç¢ºä¿åŠæ™‚æ¸…ç†ã€‚
    
    **éåŒæ­¥åˆªé™¤**ï¼šè¨Šæ¯è™•ç†å·¥ä½œæµç¨‹ä¹‹å¤–çš„ç¨ç«‹èƒŒæ™¯ç¨‹åºæ ¹æ“šå­˜æ´»æ™‚é–“ï¼ˆTTLï¼‰æˆ–å…¶ä»–æ¢ä»¶è™•ç†æ¸…ç†ã€‚é€™å°‡åˆªé™¤ç¨‹åºèˆ‡è¨Šæ¯è™•ç†è§£è€¦ï¼Œä½†éœ€è¦é¡å¤–çš„åŸºç¤è¨­æ–½ã€‚

### 2. æ¢ä»¶å¼æ‡‰ç”¨

ä¸¦éæ¯å€‹è¨Šæ¯éƒ½éœ€è¦ Claim-Check æ¨¡å¼ã€‚å¯¦ä½œé‚è¼¯ä»¥é¸æ“‡æ€§åœ°æ‡‰ç”¨å®ƒï¼š

```javascript
async function sendMessage(payload) {
  const MESSAGE_SIZE_THRESHOLD = 256 * 1024; // 256KB
  
  if (payload.length > MESSAGE_SIZE_THRESHOLD) {
    // ä½¿ç”¨ Claim-Check æ¨¡å¼
    const token = await dataStore.save(payload);
    await messagingSystem.send({ claimCheck: token });
  } else {
    // ç›´æ¥å‚³é€
    await messagingSystem.send({ data: payload });
  }
}
```

é€™ç¨®æ¢ä»¶å¼æ–¹æ³•ï¼š
- æ¸›å°‘å°å‹è¨Šæ¯çš„å»¶é²
- å„ªåŒ–è³‡æºåˆ©ç”¨
- æå‡æ•´é«”ååé‡

### 3. å®‰å…¨æ€§è€ƒé‡

claim-check æ¬Šæ–æ‡‰è©²ï¼š
- **å”¯ä¸€**ï¼šé˜²æ­¢è¡çªå’Œæœªæˆæ¬Šå­˜å–
- **éš±æ™¦**ï¼šä½¿ç”¨ UUID æˆ–åŠ å¯†é›œæ¹Šï¼Œè€Œéå¾ªåº ID
- **æœ‰æ™‚é™**ï¼šå¯¦ä½œéæœŸæ©Ÿåˆ¶ä»¥é˜²æ­¢ç„¡é™æœŸå„²å­˜
- **å­˜å–æ§åˆ¶**ï¼šç¢ºä¿åªæœ‰æˆæ¬Šçš„æ‡‰ç”¨ç¨‹å¼å¯ä»¥å–å›è² è¼‰

```javascript
// ç”¢ç”Ÿå®‰å…¨çš„ claim-check æ¬Šæ–
function generateClaimCheck() {
  return {
    id: crypto.randomUUID(),
    signature: crypto.createHmac('sha256', secretKey)
                    .update(id)
                    .digest('hex'),
    expiresAt: Date.now() + TTL
  };
}
```

## ä½•æ™‚ä½¿ç”¨ Claim-Check æ¨¡å¼

### ä¸»è¦ä½¿ç”¨æ¡ˆä¾‹

!!!success "âœ… ç†æƒ³æƒ…å¢ƒ"
    **è¨Šæ¯ç³»çµ±é™åˆ¶**ï¼šç•¶è¨Šæ¯å¤§å°è¶…éç³»çµ±é™åˆ¶æ™‚ï¼Œå°‡è² è¼‰å¸è¼‰åˆ°å¤–éƒ¨å„²å­˜ã€‚
    
    **æ•ˆèƒ½å„ªåŒ–**ï¼šç•¶å¤§å‹è¨Šæ¯é™ä½è¨Šæ¯ç³»çµ±æ•ˆèƒ½æ™‚ï¼Œå°‡å„²å­˜èˆ‡å‚³éåˆ†é›¢ã€‚

### æ¬¡è¦ä½¿ç”¨æ¡ˆä¾‹

!!!info "ğŸ“‹ é¡å¤–å„ªå‹¢"
    **æ•æ„Ÿè³‡æ–™ä¿è­·**ï¼šå°‡æ•æ„Ÿè³‡è¨Šå„²å­˜åœ¨å…·æœ‰æ›´åš´æ ¼å­˜å–æ§åˆ¶çš„å®‰å…¨è³‡æ–™å„²å­˜ä¸­ï¼Œä½¿å…¶é é›¢è¨Šæ¯ç³»çµ±ã€‚
    
    **è¤‡é›œè·¯ç”±**ï¼šç•¶è¨Šæ¯ç©¿è¶Šå¤šå€‹å…ƒä»¶æ™‚ï¼Œé€éåƒ…åœ¨ä¸­ä»‹å±¤å‚³éæ¬Šæ–ä¾†é¿å…é‡è¤‡çš„åºåˆ—åŒ–/ååºåˆ—åŒ–é–‹éŠ·ã€‚

```mermaid
graph TD
    A[è¨Šæ¯å¤§å°åˆ†æ] --> B{å¤§å° > é–¾å€¼ï¼Ÿ}
    B -->|æ˜¯| C[ä½¿ç”¨ Claim-Check]
    B -->|å¦| D{åŒ…å«æ•æ„Ÿè³‡æ–™ï¼Ÿ}
    D -->|æ˜¯| C
    D -->|å¦| E{è¤‡é›œè·¯ç”±ï¼Ÿ}
    E -->|æ˜¯| C
    E -->|å¦| F[ç›´æ¥è¨Šæ¯å‚³é]
    
    style C fill:#51cf66,stroke:#2f9e44
    style F fill:#4dabf7,stroke:#1971c2
```

## æ¶æ§‹å“è³ªå±¬æ€§

Claim-Check æ¨¡å¼å½±éŸ¿å¤šå€‹æ¶æ§‹å“è³ªå±¬æ€§ï¼š

### å¯é æ€§

å°‡è³‡æ–™èˆ‡è¨Šæ¯åˆ†é›¢å¯å¯¦ç¾ï¼š
- **è³‡æ–™å†—é¤˜**ï¼šå¤–éƒ¨è³‡æ–™å„²å­˜é€šå¸¸æä¾›æ›´å¥½çš„è¤‡è£½å’Œå‚™ä»½
- **ç½é›£å¾©åŸ**ï¼šè² è¼‰å¯ä»¥ç¨ç«‹æ–¼è¨Šæ¯ç³»çµ±é€²è¡Œå¾©åŸ
- **æ•…éšœéš”é›¢**ï¼šè¨Šæ¯ç³»çµ±æ•…éšœä¸æœƒå½±éŸ¿å·²å„²å­˜çš„è² è¼‰

### å®‰å…¨æ€§

æ­¤æ¨¡å¼é€éä»¥ä¸‹æ–¹å¼å¢å¼·å®‰å…¨æ€§ï¼š
- **è³‡æ–™éš”é›¢**ï¼šæ•æ„Ÿè³‡æ–™ä¿ç•™åœ¨å…·æœ‰æ›´åš´æ ¼å­˜å–æ§åˆ¶çš„å®‰å…¨å„²å­˜ä¸­
- **å­˜å–æ§åˆ¶**ï¼šåªæœ‰å…·æœ‰æœ‰æ•ˆæ¬Šæ–çš„æœå‹™æ‰èƒ½å–å›è² è¼‰
- **ç¨½æ ¸è»Œè·¡**ï¼šç¨ç«‹å„²å­˜å¯å¯¦ç¾è©³ç´°çš„å­˜å–è¨˜éŒ„

### æ•ˆèƒ½

æ•ˆèƒ½æ”¹é€²åŒ…æ‹¬ï¼š
- **æ¸›å°‘è¨Šæ¯å¤§å°**ï¼šè¨Šæ¯ç³»çµ±åƒ…è™•ç†è¼•é‡ç´šæ¬Šæ–
- **å„ªåŒ–å„²å­˜**ï¼šæ¯å€‹ç³»çµ±ï¼ˆè¨Šæ¯ vs. è³‡æ–™å„²å­˜ï¼‰è™•ç†å…¶æœ€æ“…é•·çš„äº‹æƒ…
- **é¸æ“‡æ€§å–å›**ï¼šæ¥æ”¶è€…åƒ…åœ¨éœ€è¦æ™‚å–å¾—è² è¼‰

### æˆæœ¬å„ªåŒ–

æˆæœ¬å„ªå‹¢ä¾†è‡ªï¼š
- **æ›´ä¾¿å®œçš„è¨Šæ¯å‚³é**ï¼šé¿å…ç‚ºå¤§å‹è¨Šæ¯æ”¯æ´ä»˜è²»çš„é€²éšåŠŸèƒ½
- **å„²å­˜åˆ†å±¤**ï¼šç‚ºå¤§å‹è² è¼‰ä½¿ç”¨å…·æˆæœ¬æ•ˆç›Šçš„å„²å­˜
- **è³‡æºæ•ˆç‡**ï¼šæ›´å¥½åœ°åˆ©ç”¨è¨Šæ¯åŸºç¤è¨­æ–½

## æ¬Šè¡¡èˆ‡è€ƒé‡

èˆ‡ä»»ä½•æ¨¡å¼ä¸€æ¨£ï¼ŒClaim-Check å¼•å…¥äº†æ¬Šè¡¡ï¼š

!!!warning "âš ï¸ æ½›åœ¨ç¼ºé»"
    **å¢åŠ è¤‡é›œæ€§**ï¼šéœ€è¦é¡å¤–çš„åŸºç¤è¨­æ–½å’Œå”èª¿
    
    **å»¶é²**ï¼šå–å›è² è¼‰éœ€è¦é¡å¤–çš„ç¶²è·¯å¾€è¿”
    
    **ä¸€è‡´æ€§æŒ‘æˆ°**ï¼šç¢ºä¿è¨Šæ¯å’Œè² è¼‰ä¿æŒåŒæ­¥
    
    **ç‡Ÿé‹é–‹éŠ·**ï¼šç®¡ç†å·²å„²å­˜è² è¼‰çš„ç”Ÿå‘½é€±æœŸ

æ ¹æ“šæ‚¨çš„ç‰¹å®šéœ€æ±‚è©•ä¼°é€™äº›æ¬Šè¡¡ã€‚ç•¶è¨Šæ¯å¤§å°æˆ–æ•ˆèƒ½å•é¡Œè¶…éå¢åŠ çš„è¤‡é›œæ€§æ™‚ï¼Œæ­¤æ¨¡å¼æ•ˆæœæœ€ä½³ã€‚

## å¯¦éš›å¯¦ä½œæ¨¡å¼

### æ¨¡å¼ 1ï¼šè‡ªå‹•æ¬Šæ–ç”¢ç”Ÿ

ä½¿ç”¨äº‹ä»¶é©…å‹•æ©Ÿåˆ¶åœ¨æª”æ¡ˆä¸Šå‚³æ™‚è‡ªå‹•ç”¢ç”Ÿæ¬Šæ–ï¼š

```javascript
// æª”æ¡ˆä¸Šå‚³è§¸ç™¼è‡ªå‹• claim-check ç”¢ç”Ÿ
dataStore.on('upload', async (file) => {
  const token = generateClaimCheck(file.id);
  await messagingSystem.send({
    event: 'file-uploaded',
    claimCheck: token,
    metadata: file.metadata
  });
});
```

### æ¨¡å¼ 2ï¼šæ‰‹å‹•æ¬Šæ–ç”¢ç”Ÿ

æ‡‰ç”¨ç¨‹å¼æ˜ç¢ºç®¡ç†æ¬Šæ–å»ºç«‹å’Œè² è¼‰å„²å­˜ï¼š

```javascript
// æ‡‰ç”¨ç¨‹å¼æ§åˆ¶æ•´å€‹ç¨‹åº
async function processLargeOrder(order) {
  const token = await storeOrderDocuments(order.documents);
  await sendOrderMessage({
    orderId: order.id,
    claimCheck: token
  });
}
```

## çµè«–

Claim-Check æ¨¡å¼ç‚ºè¨Šæ¯ç³»çµ±ä¸­è™•ç†å¤§å‹è² è¼‰çš„æŒ‘æˆ°æä¾›äº†å„ªé›…çš„è§£æ±ºæ–¹æ¡ˆã€‚é€éå°‡å„²å­˜èˆ‡è¨Šæ¯å‚³éåˆ†é›¢ï¼Œå®ƒä½¿ç³»çµ±èƒ½å¤ ï¼š

- å…‹æœè¨Šæ¯å¤§å°é™åˆ¶
- ç¶­æŒé«˜æ•ˆèƒ½
- å¢å¼·å®‰å…¨æ€§å’Œå¯é æ€§
- å„ªåŒ–æˆæœ¬

é›–ç„¶å®ƒå¼•å…¥äº†é¡å¤–çš„è¤‡é›œæ€§ï¼Œä½†åœ¨è™•ç†å¤§å‹è³‡æ–™å‚³è¼¸çš„ç³»çµ±ä¸­ï¼Œå…¶å„ªå‹¢é€šå¸¸é è¶…éæˆæœ¬ã€‚ç•¶æ‚¨çš„è¨Šæ¯åŸºç¤è¨­æ–½åœ¨è² è¼‰å¤§å°ä¸Šé‡åˆ°å›°é›£ï¼Œæˆ–ç•¶æ‚¨éœ€è¦åœ¨ç¶­æŒé«˜æ•ˆè¨Šæ¯å‚³éçš„åŒæ™‚ä¿è­·æ•æ„Ÿè³‡æ–™æ™‚ï¼Œè«‹è€ƒæ…®å¯¦ä½œæ­¤æ¨¡å¼ã€‚

## ç›¸é—œæ¨¡å¼

- **éåŒæ­¥è«‹æ±‚-å›è¦†**ï¼šè£œå…… Claim-Check ç”¨æ–¼é•·æ™‚é–“åŸ·è¡Œçš„æ“ä½œ
- **ç«¶çˆ­æ¶ˆè²»è€…**ï¼šèˆ‡ Claim-Check é…åˆè‰¯å¥½ç”¨æ–¼å¹³è¡Œè™•ç†
- **åˆ†å‰²èˆ‡èšåˆ**ï¼šè™•ç†å¤§å‹è¨Šæ¯çš„æ›¿ä»£æ–¹æ³•

## åƒè€ƒè³‡æ–™

- [Enterprise Integration Patterns: Claim Check](https://www.enterpriseintegrationpatterns.com/patterns/messaging/StoreInLibrary.html)
- [Microsoft Azure Architecture Patterns: Claim-Check](https://learn.microsoft.com/en-us/azure/architecture/patterns/claim-check)
