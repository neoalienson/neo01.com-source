---
title: データバックアップ戦略 - 計画から復旧まで
date: 2022-09-26
lang: ja
categories: Architecture
tags:
  - Backup
  - Data Protection
  - Disaster Recovery
  - Best Practices
excerpt: "バックアップは単なるファイルのコピーではありません。データ損失、ランサムウェア、災害から保護する弾力性のあるバックアップ戦略の設計方法を学びましょう。"
thumbnail: /assets/database/backup_thumbnail.jpeg
---

自動バックアップを設定しました。ファイルは毎晩別のドライブにコピーされます。データが保護されていることを知って安心しています。

そしてランサムウェアが襲いました。メインシステムは暗号化されましたが、バックアップを確認すると、それらも暗号化されていました。マルウェアがネットワーク経由で拡散し、すべてを破壊したのです。または、開発者が本番データベースを誤って削除し、「毎日のバックアップ」が設定エラーのため実際には3週間実行されていなかったことを発見するかもしれません。

突然、そのシンプルなバックアップスクリプトはそれほど信頼できるものに感じられなくなりました。

効果的なデータ保護は、バックアップジョブをスケジュールするときに始まるのではありません。システム設計時に始まります。バックアップタイプ、保持ポリシー、ストレージの場所について行う決定が、災害から復旧できるか、すべてを失うかを決定します。

これはバックアップソフトウェアやクラウドプロバイダーについてではありません。戦略についてです。データ損失を防ぐバックアップシステムの設計についてであり、単にデータ損失を防ぐことを約束するだけではありません。

## なぜバックアップ戦略が重要なのか

**災害テスト**：システムが故障し、データが破損し、攻撃者が襲ったとき、迅速かつ完全に運用を復旧できますか？それとも手遅れになってからバックアップ戦略のギャップを発見しますか？

**不適切なバックアップのコスト**：
- **データ損失**：重要なビジネスデータの永続的な損失
- **ダウンタイム**：復旧を試みる間の長時間の中断
- **コンプライアンス違反**：データ保護の失敗による規制上の罰金
- **ビジネスの失敗**：データを失った企業の60%が6か月以内に閉鎖

**適切なバックアップ戦略の価値**：
- **データ保護**：異なる時間枠にわたる複数の復旧ポイント
- **迅速な復旧**：インシデント時の最小限のダウンタイム
- **コンプライアンス**：データ保持の規制要件を満たす
- **安心**：あらゆるシナリオからデータを復旧できるという確信

!!!warning "⚠️ 必要になってからバックアップをテストすることはできません"
    災害が襲ったとき、バックアップが実際に機能するかどうかがわかります。テストされていないバックアップは高価なストレージに過ぎません。必要になる前にバックアップ戦略を設計し、テストしてください。

## バックアップの基礎

データバックアップは、損失、破損、または破壊を防ぐためにデータのコピーを作成するプロセスです。効果的なバックアップ戦略は、保護、コスト、復旧速度のバランスを取ります。

### 主要概念

**復旧ポイント目標（RPO）**：時間で測定される最大許容データ損失。どれだけのデータ損失を許容できますか？

**復旧時間目標（RTO）**：最大許容ダウンタイム。システムはどれだけ迅速に復旧する必要がありますか？

**バックアップウィンドウ**：ビジネス運用に影響を与えることなくバックアップ操作に利用できる時間。

**保持ポリシー**：バックアップが削除される前に保持される期間。

**バックアップメディア**：バックアップが保存される場所（ディスク、テープ、クラウド、光学）。

**バックアップスコープ**：バックアップに含まれるデータ（完全システム、データベース、ユーザーファイル）。

### 3-2-1ルール

バックアップ戦略の基盤：**データの3つのコピー、2つの異なるメディアタイプ、1つのオフサイト場所**。

**3つのコピー**：元のデータプラス2つのバックアップ
**2つのメディアタイプ**：異なるストレージ技術（ディスク+テープ、ローカル+クラウド）
**1つのオフサイト**：主要な場所からの地理的分離

```
主要データ（本番サーバー）
    ↓
ローカルバックアップ（ネットワーク接続ストレージ）
    ↓
オフサイトバックアップ（クラウドストレージ）
```

## バックアップタイプ

異なるバックアップタイプは、ストレージ効率、バックアップ速度、復旧の複雑さのバランスを取ります。

| バックアップタイプ | 含まれるデータ | ストレージ使用量 | バックアップ速度 | 復旧速度 | 復旧の複雑さ | 最適な使用例 |
|-------------|-------------|-------------|-------------|----------|------------|----------|
| **完全** | 選択されたすべてのデータ | 最高 | 最低 | 最高 | シンプル | 週次/月次ベースライン |
| **増分** | 前回のバックアップ以降の変更 | 最低 | 最高 | 最低 | 複雑 | 完全バックアップ間の日次 |
| **差分** | 前回の完全バックアップ以降の変更 | 中程度 | 中程度 | 中程度 | シンプル | 効率性/シンプルさのバランス |
| **合成完全** | 再構築された完全バックアップ | 効率的 | ソース影響なし | 高速 | シンプル | 限られたウィンドウの企業 |

### 完全バックアップ

前回のバックアップ時期に関係なく、選択されたデータの完全なコピー。

**利点**：
- **シンプルな復旧**：1つのバックアップセットにすべて必要なものが含まれる
- **高速復旧**：複数のバックアップセットを組み合わせる必要がない
- **独立性**：各バックアップは自己完結型

**欠点**：
- **ストレージ集約的**：最も多くのストレージ容量が必要
- **時間がかかる**：完了に最も長い時間がかかる
- **ネットワーク集約的**：最も多くのデータを転送

**使用時期**：完全なシステム保護のための週次または月次。

```bash
# 完全バックアップの例
tar -czf /backups/full_backup_$(date +%Y%m%d).tar.gz /home /etc /var/www
```

### 増分バックアップ

前回のバックアップ（完全または増分）以降に変更されたデータのみをバックアップ。

**利点**：
- **ストレージ効率**：最小限のストレージ要件
- **高速バックアップ**：迅速な完了時間
- **ネットワーク効率**：最少のデータ転送

**欠点**：
- **複雑な復旧**：完全バックアップとすべての増分バックアップが必要
- **チェーン依存**：チェーン内のバックアップが破損すると復旧が失敗
- **遅い復旧**：複数のバックアップセットを処理する必要

**使用時期**：完全バックアップ間の日次バックアップ。

```bash
# rsyncを使用した増分バックアップ
rsync -av --link-dest=/backups/previous /source/ /backups/$(date +%Y%m%d)/
```

### 差分バックアップ

前回の完全バックアップ以降に変更されたすべてのデータをバックアップ。

**利点**：
- **中程度のストレージ**：完全より効率的、増分より少ない
- **シンプルな復旧**：完全バックアップと最新の差分のみが必要
- **チェーン依存なし**：各差分は独立している

**欠点**：
- **サイズの増大**：時間の経過とともに各差分が大きくなる
- **中程度の速度**：増分より遅く、完全より速い

**使用時期**：増分と完全バックアップ戦略のバランス。

```bash
# 差分バックアップの概念
# 1日目：完全バックアップ（100GB）
# 2日目：差分（1日目以降5GBの変更）
# 3日目：差分（1日目以降12GBの変更）
# 4日目：差分（1日目以降18GBの変更）
```

### 合成完全バックアップ

元のデータにアクセスすることなく、以前の完全バックアップと後続の増分バックアップを組み合わせて完全バックアップを作成。

**利点**：
- **本番への影響なし**：ソースシステムにアクセスしない
- **ストレージ効率**：複数の完全バックアップの必要性を排除
- **高速復旧**：完全バックアップの利点を提供

**欠点**：
- **複雑なプロセス**：高度なバックアップソフトウェアが必要
- **処理オーバーヘッド**：合成中はCPU集約的

**使用時期**：大規模データセットと限られたバックアップウィンドウを持つ企業環境。

## 一般的なバックアップの誤解

!!!danger "💾 RAIDはバックアップである"
    **現実**：RAIDはドライブ障害から保護しますが、データの破損、削除、災害からは保護しません。
    
    **なぜ間違いか**：RAIDは破損をミラーリングし、ユーザーエラーから保護せず、履歴復旧ポイントを提供しません。
    
    **正しいアプローチ**：可用性にはRAID、データ保護にはバックアップを使用。

!!!warning "☁️ クラウド同期はバックアップである"
    **現実**：同期サービスは削除や破損を含む変更を複製します。
    
    **なぜ間違いか**：ローカルでファイルを削除すると、同期サービスからも削除されます。ランサムウェアや意図しない変更からの保護はありません。
    
    **正しいアプローチ**：コラボレーションには同期、保護にはバックアップを使用。

!!!error "1️⃣ 1つのバックアップで十分"
    **現実**：単一のバックアップは単一障害点を作ります。
    
    **なぜ間違いか**：バックアップの破損、ストレージ障害、または災害によって唯一のコピーが失われる可能性があります。
    
    **正しいアプローチ**：3-2-1ルールに従い、複数のバックアップコピーを作成。

!!!failure "🧪 バックアップにテストは不要"
    **現実**：テストされていないバックアップは最も必要な時に失敗します。
    
    **なぜ間違いか**：バックアッププロセスは静かに失敗し、設定がドリフトし、復旧手順が壊れる可能性があります。
    
    **正しいアプローチ**：定期的なバックアップテストと復旧訓練。

!!!question "📝 バージョン管理はバックアップである"
    **現実**：バージョン管理システムは変更を追跡しますが、包括的なバックアップソリューションではありません。
    
    **なぜ制限があるか**：Git/SVNはコミットされたコードのみを保護し、データベース、設定、またはコミットされていない作業は保護しません。リポジトリの破損やホスティングプロバイダーの障害からの保護はありません。
    
    **正しいアプローチ**：コード履歴にはバージョン管理、リポジトリ、データベース、インフラを含む完全なシステム保護にはバックアップを使用。

## バックアップセキュリティのベストプラクティス

### すべてを暗号化

すべてのバックアップは、機密データを不正アクセスから保護するために暗号化する必要があります。

**なぜ暗号化が重要か**：2021年、あるヘルスケアプロバイダーの暗号化されていないバックアップテープが配送車両から盗まれ、120万人の患者記録が漏洩しました。暗号化されていれば、盗まれたデータは無用になっていたでしょう。

**転送中の暗号化**：TLS/SSLを使用してバックアップ転送中のデータを保護
**保存時の暗号化**：AES-256暗号化で保存されたバックアップデータを保護
**キー管理**：安全な暗号化キーの保存とローテーション

```bash
# アップロード前のクライアントサイド暗号化
gpg --cipher-algo AES256 --compress-algo 1 --symmetric \
    --output backup.tar.gz.gpg backup.tar.gz

# 暗号化バックアップのアップロード
aws s3 cp backup.tar.gz.gpg s3://secure-backups/ --sse AES256

# 暗号化されたデータベースバックアップ
mysqldump --single-transaction --routines --triggers database_name | \
    gpg --symmetric --cipher-algo AES256 > db_backup_$(date +%Y%m%d).sql.gpg
```

### アクセス制御

内部脅威や意図しない損害を防ぐため、バックアップにアクセス、変更、または削除できる人を制限します。

**なぜアクセス制御が重要か**：2019年、ある金融会社の不満を持つ従業員が退職前に重要なバックアップを削除し、数週間の復旧作業を引き起こしました。適切なアクセス制御があれば、これを防ぐことができたでしょう。

**最小権限の原則**：必要最小限の権限を付与
**ロールベースアクセス**：異なるロールに異なる権限
**多要素認証**：バックアップシステムアクセスにMFAを要求
**監査ログ**：すべてのバックアップアクセスと変更を追跡

### エアギャップバックアップ

物理的または論理的に分離されたバックアップで、リモートアクセスできず、サイバー攻撃に対する究極の保護を提供します。

**なぜエアギャップが重要か**：ランサムウェアやマルウェアはネットワーク接続を通じて拡散します。攻撃者がシステムを侵害すると、ネットワークをスキャンして接続されたストレージ、バックアップサーバー、共有ドライブを探してバックアップを暗号化または削除します。エアギャップバックアップは物理的または論理的にネットワークから切断されており、ネットワークベースの攻撃からは到達不可能です。2017年のWannaCryランサムウェア攻撃の際、エアギャップバックアップを持つ組織は数時間内に復旧しました。マルウェアがオフラインストレージに拡散できなかったためですが、ネットワークバックアップシステムは本番データとともに暗号化されました。

```bash
# 週次オフラインバックアッププロセス
# 1. 外部ドライブを接続
sudo mount /dev/sdb1 /mnt/offline_backup

# 2. 暗号化バックアップを作成
tar -czf - /critical/data | gpg --symmetric > /mnt/offline_backup/backup_$(date +%Y%m%d).tar.gz.gpg

# 3. バックアップの整合性を検証
sha256sum /mnt/offline_backup/backup_$(date +%Y%m%d).tar.gz.gpg > /mnt/offline_backup/backup_$(date +%Y%m%d).sha256

# 4. 安全にアンマウントしてオフライン保存
sudo umount /mnt/offline_backup
```

## データ価値評価フレームワーク

すべてのデータが同じレベルのバックアップ保護を必要とするわけではありません。効果的なバックアップ戦略は、異なるデータタイプのビジネス価値を理解し、何を保護するかについて意識的な決定を下すことから始まります。

### 実世界の例：このブログのアプローチ

このブログは実用的なデータ価値評価を示しています。バックアップ戦略について書いているにもかかわらず、すべてをバックアップしているわけではありません：

**データ分類**：
- **高価値**：ブログコンテンツ（記事、設定）- Gitでバックアップ
- **中程度の価値**：アナリティクスデータ - 失っても受け入れられる、再構築可能
- **低価値**：コメント（SaaS管理）- あると良いがビジネスに重要ではない

**意思決定フレームワーク**：
```
コメントデータバックアップ分析：
コスト：
- API統合開発：8-16時間
- インフラセットアップ：4-8時間
- 継続メンテナンス：月あ2時間
- ストレージコスト：月額5-10ドル

価値：
- 失った場合のビジネス影響：最小限
- 収益影響：なし
- 再構築の可能性：不可能だが受け入れられる

決定：リスクを受け入れ、バックアップしない
```

**SaaS責任移転**：
サードパーティサービス（Commentbox.io）を使用することで、バックアップ責任を専門家に移転します：
- 専門的な知識を持っている
- エンタープライズグレードの戦略を実装
- 私たちが達成できるよりも優れた信頼性を提供
- 多くの顧客にコストを分散

### データ価値評価プロセス

**ステップ1：データを分類する**
```yaml
data_classification:
  critical:
    - customer_records
    - financial_transactions
    - intellectual_property
    impact_if_lost: "ビジネス失敗"
    backup_priority: "最高"
  
  important:
    - user_content
    - configuration_files
    - historical_data
    impact_if_lost: "重大な中断"
    backup_priority: "高"
  
  useful:
    - logs
    - analytics
    - comments
    impact_if_lost: "軽微な不便"
    backup_priority: "低またはなし"
```

**ステップ2：保護コストを計算する**
- バックアップ実装の開発時間
- インフラとストレージコスト
- 継続的なメンテナンスオーバーヘッド
- コンプライアンスとセキュリティ要件

**ステップ3：ビジネス影響を評価する**
- データが利用不可の場合の収益損失
- データを再作成または再構築するコスト
- データ損失に対する規制上の罰則
- 顧客の信頼と評判への影響

**ステップ4：意識的な決定を下す**
- 価値がコストを上回る場合は保護する
- コストが価値を上回る場合はリスクを受け入れる
- 決定と理由を文書化する
- 再評価のためのレビュースケジュールを設定する

### 定期レビュープロセス

データの価値は時間とともに変化します。定期的なレビューサイクルを確立しましょう：

**四半期評価の質問**：
- データ量や重要性が増加したか？
- ビジネスモデルや収益源が変化したか？
- 新しいコンプライアンス要件があるか？
- バックアップソリューションのコストが下がったか？
- ニアミスインシデントがあったか？

**バックアップ実装のトリガーポイント**：
- データが収益源になる
- 規制要件が発生する
- ビジネスモデルがデータ依存にシフトする
- 時間の経過とともに歴史的価値が発展する
- 損失コストが保護コストを上回る

!!!tip "💡 バックアップの決定はビジネスの決定"
    すべてのデータがバックアップを必要とするわけではありません。重要なのは、ビジネス価値、復旧コスト、リスク許容度に基づいて意識的で情報に基づいた決定を下し、ビジネスの発展に合わせて定期的に再評価することです。時にはリスクを受け入れることが正しい選択です。

## 選択をする

データバックアップはオプションではありません——必須です。しかし、保護レベルはデータのビジネス価値と一致するべきです。問題は、必要になる前に包括的なバックアップ戦略を設計するか、データ損失後に慣てて復旧しようとするかです。

要件の理解から始めましょう：RPO、RTO、コンプライアンスニーズ。ビジネス価値でデータを分類し、適切な保護レベルを実装します。重要なデータには3-2-1ルールを使用し、低価値データにはリスクを受け入れ、ビジネスの発展に合わせて定期的に再評価します。

記憶しておいてください：バックアップはデータ損失に対するセーフティネットです。正しいデータに対して正しく実装されると、信頼と安心を提供します。間違って実装されたり不必要な場合は、リソースを無駄にします。低価値データに対して意識的にスキップする場合は、スマートなリソース配分を表します。

最初からバックアップ戦略を設計してくださいが、常にビジネス価値の観点から行ってください。将来のあなた——そしてあなたのビジネス——が感謝するでしょう。